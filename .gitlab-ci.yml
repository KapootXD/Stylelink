stages:
  - install
  - lint
  - test
  - e2e
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - when: always  # Fallback to always run pipelines

cache:
  paths:
    - node_modules/
    - .npm/

install_dependencies:
  stage: install
  image: node:18
  script:
    - npm ci --cache .npm --prefer-offline
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - merge_requests

lint:
  stage: lint
  image: node:18
  script:
    - npm run lint
  needs:
    - install_dependencies
  only:
    - main
    - merge_requests

unit_tests:
  stage: test
  image: node:18
  script:
    - npm run test:coverage
  coverage: '/Lines\s*:\s*(\d+\.?\d*)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  needs:
    - install_dependencies
  only:
    - main
    - merge_requests

e2e_tests:
  stage: e2e
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  variables:
    # Enable guest mode for E2E tests (allows testing protected routes)
    REACT_APP_ALLOW_GUEST_MODE: "true"
    # Use demo mode or set minimal Firebase config for tests
    REACT_APP_USE_FIREBASE_EMULATOR: "false"
    # Minimal Firebase config for app to start (can use dummy values in demo mode)
    REACT_APP_FIREBASE_API_KEY: "test-api-key"
    REACT_APP_FIREBASE_AUTH_DOMAIN: "test.firebaseapp.com"
    REACT_APP_FIREBASE_PROJECT_ID: "test-project"
    REACT_APP_FIREBASE_STORAGE_BUCKET: "test.appspot.com"
    REACT_APP_FIREBASE_MESSAGING_SENDER_ID: "123456789"
    REACT_APP_FIREBASE_APP_ID: "1:123456789:web:test"
  script:
    - npm ci --cache .npm --prefer-offline
    - npx playwright install chromium --with-deps
    - npm run test:e2e -- --project=chromium-desktop
  artifacts:
    when: on_failure
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  needs:
    - install_dependencies
  only:
    - main
    - merge_requests
  allow_failure: true  # Allow E2E to fail without blocking pipeline

build:
  stage: build
  image: node:18
  variables:
    # Ensure emulators are disabled for production builds
    REACT_APP_USE_FIREBASE_EMULATOR: "false"
    # Firebase config will be set from GitLab CI/CD variables
    # If variables are not set in GitLab, build will use demo mode
    REACT_APP_FIREBASE_API_KEY: $FIREBASE_API_KEY
    REACT_APP_FIREBASE_AUTH_DOMAIN: $FIREBASE_AUTH_DOMAIN
    REACT_APP_FIREBASE_PROJECT_ID: $FIREBASE_PROJECT_ID
    REACT_APP_FIREBASE_STORAGE_BUCKET: $FIREBASE_STORAGE_BUCKET
    REACT_APP_FIREBASE_MESSAGING_SENDER_ID: $FIREBASE_MESSAGING_SENDER_ID
    REACT_APP_FIREBASE_APP_ID: $FIREBASE_APP_ID
    REACT_APP_FIREBASE_MEASUREMENT_ID: $FIREBASE_MEASUREMENT_ID
  script:
    # Install dependencies (artifacts might have expired)
    - npm ci --cache .npm --prefer-offline
    # Verify Firebase variables are set (warn if missing but don't fail)
    - |
      if [ -z "$FIREBASE_API_KEY" ] || [ -z "$FIREBASE_PROJECT_ID" ]; then
        echo "⚠️  Warning: Firebase variables not set in GitLab CI/CD"
        echo "Build will proceed in demo mode"
      fi
    # Run build
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 week
  needs:
    - install_dependencies
    - unit_tests
    - e2e_tests
  only:
    - main
    - merge_requests

deploy_to_firebase:
  stage: deploy
  image: node:18
  script:
    - npm install -g firebase-tools
    - firebase deploy --only hosting --token $FIREBASE_TOKEN --non-interactive
  needs:
    - build
  only:
    - main
  when: on_success
  environment:
    name: production
    url: https://stylelink-74fdf.web.app
