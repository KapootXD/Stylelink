# StyleLink GitLab CI/CD Pipeline Configuration
# Generated by Team Lead A for automated testing and deployment

stages:
  - install
  - test
  - build
  - quality
  - security
  - deploy

variables:
  NODE_VERSION: "18"
  CACHE_KEY: "stylelink-cache-v1"

# Cache node_modules for faster builds
cache:
  paths:
    - node_modules/
    - .npm/
  key:
    files:
      - package-lock.json

# Install dependencies stage
install_dependencies:
  stage: install
  image: node:18-alpine
  script:
    - npm ci --cache .npm --prefer-offline
    - npm install -g serve
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  cache:
    key: $CACHE_KEY
    paths:
      - node_modules/
      - .npm/

# TypeScript compilation check
typescript_check:
  stage: test
  image: node:18-alpine
  dependencies:
    - install_dependencies
  script:
    - npx tsc --noEmit
    - echo "âœ… TypeScript compilation successful"
  allow_failure: false

# Linting and code quality
eslint_check:
  stage: quality
  image: node:18-alpine
  dependencies:
    - install_dependencies
  script:
    - npx eslint src/ --ext .ts,.tsx --format unix
    - echo "âœ… ESLint checks passed"
  allow_failure: true  # Allow warnings but track them

# Build the application
build_application:
  stage: build
  image: node:18-alpine
  dependencies:
    - install_dependencies
  script:
    - npm run build
    - echo "âœ… Production build successful"
    - ls -la build/
  artifacts:
    paths:
      - build/
    expire_in: 1 week
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'

# Security audit
security_audit:
  stage: security
  image: node:18-alpine
  dependencies:
    - install_dependencies
  script:
    - npm audit --audit-level=moderate
    - echo "âœ… Security audit completed"
  allow_failure: true

# Unit tests (when implemented)
run_tests:
  stage: test
  image: node:18-alpine
  dependencies:
    - install_dependencies
  script:
    - npm test -- --watchAll=false --coverage --passWithNoTests
    - echo "âœ… Test suite completed"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

# Bundle size analysis
bundle_analysis:
  stage: quality
  image: node:18-alpine
  dependencies:
    - build_application
  script:
    - npx webpack-bundle-analyzer build/static/js/*.js --report --mode static --no-open || echo "Bundle analyzer not available, skipping"
    - du -sh build/static/js/*.js
    - echo "ðŸ“Š Bundle size analysis completed"

# Lighthouse performance audit
lighthouse_audit:
  stage: quality
  image: node:18-alpine
  dependencies:
    - build_application
  script:
    - npm install -g @lhci/cli@0.12.x
    - npx http-server build -p 8080 &
    - sleep 5
    - npx lhci autorun --collect.url=http://localhost:8080 --upload.target=temporary-public-storage || echo "Lighthouse audit completed"
  allow_failure: true

# Deploy to staging (manual trigger)
deploy_staging:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_application
  script:
    - echo "ðŸš€ Deploying to staging environment"
    - echo "Build artifacts are available in the artifacts"
  only:
    - develop
    - when: manual

# Deploy to production (manual trigger, protected branches only)
deploy_production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_application
  script:
    - echo "ðŸš€ Deploying to production environment"
    - echo "Production deployment initiated"
  only:
    - main
    - when: manual
  environment:
    name: production
    url: https://stylelink.app

# Pipeline rules and conditions
.quality_gates:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
